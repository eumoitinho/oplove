# Sistema de Database - Context

## Propósito do Sistema
Foundation PostgreSQL com 45+ tabelas, RLS policies, performance optimization, backup/recovery e monitoring para suportar toda a plataforma OpenLove em produção.

## Componentes Principais
- **PostgreSQL 15**: Database principal via Supabase
- **45+ Active Tables**: Schema completo da aplicação
- **Row Level Security**: Políticas granulares de acesso
- **Triggers & Functions**: Automação e validação
- **Materialized Views**: Performance de queries complexas
- **Backup Strategy**: Daily + weekly com retention
- **Health Monitoring**: Slow queries, connections, performance

## Dependências
### Internas
- Todos os sistemas dependem do database
- Cache Redis para otimização
- Real-time subscriptions via WebSocket

### Externas
- Supabase (BaaS provider)
- PostgreSQL extensions
- Automated backup systems
- Monitoring tools

## Estado Atual
✅ **Otimizado para Produção**
- **45+ tabelas** ativas e funcionais
- **Performance otimizada**: Queries <200ms average
- **RLS completo**: Segurança granular implementada
- **Backup automático**: Daily + disaster recovery
- **Health monitoring**: Automated alerts
- **Connection pooling**: 60% utilization average
- **Index optimization**: 95%+ hit ratio

## Problemas Conhecidos
1. **Sequential Scans**: Algumas queries complexas ainda fazem full scan
2. **Lock Contention**: Updates concorrentes em contadores
3. **Connection Pool**: Occasional exhaustion em picos
4. **RLS Overhead**: Performance impact em queries complexas

## TODOs Críticos
- [ ] Implementar read replicas para queries de leitura
- [ ] Adicionar partitioning em tabelas grandes (messages, posts)
- [ ] Otimizar queries com EXPLAIN ANALYZE review
- [ ] Implementar archiving de dados antigos

## Métricas Críticas
- **Query performance**: 180ms average (target: <200ms)
- **Connection utilization**: 60% (healthy)
- **Index hit ratio**: 95.8% (excellent)
- **Cache hit ratio**: 85.2% (good)
- **Database size**: 45GB (growing 2GB/month)
- **Backup success rate**: 100% (últimos 90 dias)

## Schema Overview
### Core Tables (15)
- users, user_profiles, follows, user_blocks
- posts, post_likes, post_comments, post_shares
- conversations, messages, participants
- subscriptions, payment_history
- user_verifications, user_credits

### Feature Tables (30+)
- stories, story_views, story_boosts
- profile_seals, user_profile_seals
- credit_transactions, payouts
- notifications, user_reports
- daily_limits, rate_limiting

## Performance Benchmarks
- **Timeline queries**: 45ms average
- **Profile loading**: 35ms average
- **Message queries**: 25ms average
- **Complex analytics**: 150ms average
- **Write operations**: 20ms average

## Backup & Recovery
- **Daily backups**: 03:00 UTC automated
- **Weekly full**: Sunday 01:00 UTC
- **Retention**: 30 days daily, 12 weeks weekly
- **Point-in-time**: Up to 7 days
- **RTO**: 4 hours
- **RPO**: 15 minutes

## Responsável Técnico
- Sistema crítico para toda plataforma
- Performance diretamente impacta UX
- Backup strategy essencial para business
- Scaling strategy precisa de planejamento proativo